#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# parse args
BUILD_DIR=$1
CACHE_DIR=$2

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

# Node Installation --------------------------

BUILD_DIR=$(mktemp -d -t node.XXXXXX)

curl --silent --location https://raw.github.com/abhishekmunie/heroku-buildpack-static-js/master/conf/package.json > $BUILD_DIR/package.json

curl --silent --location https://raw.github.com/heroku/heroku-buildpack-nodejs/master/bin/compile > compile_node
chmod 755 compile_node
./compile_node $BUILD_DIR $CACHE_DIR

export PATH=$BUILD_DIR/bin:$BUILD_DIR/node_modules/.bin:$PATH

#find $BUILD_DIR | sed -e 's/[^-][^\/]*\//--/g;s/--/ |-/'

# css compilation ----------------------------

BUILD_DIR=$1

echo -n "-----> Making Coffee..."
coffee --compile --output ${BUILD_DIR} ${BUILD_DIR} | indent
echo "done"

# Closure Compiler Fetch --------------------
echo -n "-----> Fetching Closure Compiler..."
curl --silent --location http://closure-compiler.googlecode.com/files/compiler-latest.tar.gz | tar xz
echo "done"

# js compilation ----------------------------

echo "-----> Compiling JS files..."
find ${BUILD_DIR} -iregex ".*\.js" \! -iregex ".*\.min\.js" | while read -r jsfile
do
  echo -n "-----> compiling ${jsfile#*$BUILD_DIR/}..." | indent
  fname=${jsfile%.*}
  java -jar compiler.jar --js_output_file "$fname.min.js" --js "$jsfile" | indent
  jssha1=`openssl sha1 "$jsfile"`
  jssha1=${jssha1#*= }
  jssha1=${jssha1:0:8}
  cp "$fname.min.js" "$fname.$jssha1.js"
  echo "done"
done
echo "       done."

# init default nginx configuration ----------

if [ -f "${BUILD_DIR}/conf" ]; then
  echo "-----> Using existing nginx configuration."
else
  echo -n "-----> Creating default nginx configuration."
  mkdir ${BUILD_DIR}/conf
  curl --silent --location https://raw.github.com/abhishekmunie/heroku-buildpack-static-js/master/conf/mime.types > ${BUILD_DIR}/conf/mime.types
  curl --silent --location https://raw.github.com/abhishekmunie/heroku-buildpack-static-js/master/conf/nginx.conf.erb > ${BUILD_DIR}/conf/nginx.conf.erb
  echo "done"
fi

# Nginx -------------------------------------

curl --silent --location https://raw.github.com/abhishekmunie/heroku-buildpack-nginx/master/bin/compile > compile_nginx

chmod +x compile_nginx
./compile_nginx $BUILD_DIR $CACHE_DIR